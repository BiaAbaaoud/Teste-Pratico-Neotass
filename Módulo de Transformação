import pandas as pd
import numpy as np
import logging

logger = logging.getLogger(__name__)

def clean_cnpj(series: pd.Series) -> pd.Series:
    """
    Rotina Pythonic e Vetorizada (diminuição do código/performance) para limpar CNPJs.
    - Remove caracteres especiais (pontos, barras, hifens).
    - Aplica a função de string em toda a Série do Pandas de uma vez.
    """
    return series.astype(str).str.replace(r'[\./-]', '', regex=True).str.strip().str.lower()

def transform_data(df_oportunidades: pd.DataFrame, df_sellout: pd.DataFrame) -> dict:
    """
    Realiza a limpeza de IDs, a modelagem dimensional e a criação de Fatos e Dimensões.
    """
    logger.info("Iniciando a Etapa de Transformação (Limpeza CNPJ e Modelagem Dimensional).")

    # 1. Limpeza dos Identificadores (Resposta ao problema do CNPJ)
    df_oportunidades['CNPJ_LIMPO'] = clean_cnpj(df_oportunidades['CNPJ_PARCEIRO'])
    df_sellout['CNPJ_LIMPO'] = clean_cnpj(df_sellout['CNPJ_CLIENTE'])

    # 2. Criação da Dimensão Parceiro (Contexto)
    todos_cnpjs = pd.concat([
        df_oportunidades['CNPJ_LIMPO'],
        df_sellout['CNPJ_LIMPO']
    ]).drop_duplicates().reset_index(drop=True).to_frame(name='CNPJ_LIMPO')
    
    # Adiciona a chave primária da Dimensão (Surrogate Key)
    todos_cnpjs['PARCEIRO_ID'] = todos_cnpjs.index + 1
    dim_parceiro = todos_cnpjs[['PARCEIRO_ID', 'CNPJ_LIMPO']]
    logger.info(f"Dimensão Parceiro criada com {len(dim_parceiro)} IDs únicos.")

    # 3. Criação da Fato Oportunidade (Métrica)
    fato_oportunidade = df_oportunidades.merge(
        dim_parceiro, on='CNPJ_LIMPO', how='left'
    )[['ID_OPORTUNIDADE', 'PARCEIRO_ID', 'VALOR_ESTIMADO', 'DATA_OPORTUNIDADE']]
    
    # 4. Criação da Fato Sellout (Métrica)
    fato_sellout = df_sellout.merge(
        dim_parceiro, on='CNPJ_LIMPO', how='left'
    )
    # Cria a métrica de valor total
    fato_sellout['VALOR_TOTAL'] = fato_sellout['QUANTIDADE'] * fato_sellout['VALOR_UNITARIO']
    fato_sellout = fato_sellout[['ID_SELLOUT', 'PARCEIRO_ID', 'QUANTIDADE', 'VALOR_TOTAL', 'DATA_SELLOUT']]
    
    logger.info("Transformação concluída. Modelo Estrela pronto para o Load.")
    
    return {
        'dim_parceiro': dim_parceiro,
        'fato_oportunidade': fato_oportunidade,
        'fato_sellout': fato_sellout
    }
